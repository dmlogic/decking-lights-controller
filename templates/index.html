<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decking lights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
</head>
<body>
    <header class="container bg-dark bg-gradient text-white">
        <div class="d-flex align-items-center">
            <h1 class="my-4">Decking lights </h1>
            <div class="spinner-border text-secondary ms-auto" role="status" id="spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="alert alert-danger m-3" role="alert" hidden id="error">
            <p><strong></strong></p>
            <p>Please refresh the page to try again. If this problem persists, reboot the lights.</p>
        </div>
        <div class="form-check form-switch fs-1 my-4">
            <input class="form-check-input" type="checkbox" role="switch" id="onOff" disabled>
            <label class="form-check-label fs-3" for="onOff" id="onOffLabel"></label>
        </div>
        <div id="controls" hidden>
            <label for="rgb" class="h2 my-4">Colour</label>
            <p>
                <input id="rgb"
                       type="color">
            </p>
            <label for="white" class="h2 my-4">White</label>
            <p>
                <input type="range"
                       class="form-range"
                       min="0"
                       max="100"
                       step="1"
                       id="white">
            </p>
        </div>
    </div>
<script>
const onOffSwitch = document.getElementById("onOff")
const onOffLabel = document.getElementById("onOffLabel")
const rgbSwitch = document.getElementById("rgb")
const whiteSwitch = document.getElementById("white")
const controlsDisplay = document.getElementById("controls")
const busyIndicator = document.getElementById("spinner")
let busy = true

function setControlsVisibliity() {
    controlsDisplay.hidden = !onOffSwitch.checked
    onOffLabel.textContent = onOffSwitch.checked ? 'On' : 'Off'
}

function updateOnOffValue() {
    setControlsVisibliity();
    updateLights();
}

function setBusy() {
    busy = true;
    busyIndicator.hidden = false;
    onOffSwitch.disabled = true;
    rgbSwitch.disabled = true;
    whiteSwitch.disabled = true;
}

function setReady() {
    busy = false;
    busyIndicator.hidden = true;
    onOffSwitch.disabled = false;
    rgbSwitch.disabled = false;
    whiteSwitch.disabled = false;
}

function showError(msg) {
    document.querySelector('#error strong').textContent = msg;
    document.getElementById("error").hidden = false;
    setBusy();
}

function updateLights() {
    if(busy) {
        return;
    }
    setBusy();

    let formData = new FormData();
    formData.append('onoff', onOffSwitch.checked ? "checked" : "off");
    formData.append('rgb', rgbSwitch.value);
    formData.append('white', whiteSwitch.value);

    fetch('/update',{
        method: "POST",
        body: formData
    })
        .then((response) => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Something went wrong');
            })
        .then((responseJson) => {
            setReady();
        })
        .catch((error) => {
            showError("Could not update lights")
        });
}

function init() {
    fetch('/status')
        .then((response) => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Something went wrong');
            })
        .then((responseJson) => {
            onOffSwitch.checked = responseJson.onoff == 'checked'
            rgbSwitch.value =  responseJson.rgb
            whiteSwitch.value = responseJson.white
            setControlsVisibliity();
            setReady();
        })
        .catch((error) => {
            showError("Cannot read status from lights")
        });

}
onOffSwitch.addEventListener("change", updateOnOffValue);
rgbSwitch.addEventListener("change", updateLights);
whiteSwitch.addEventListener("change", updateLights);
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
