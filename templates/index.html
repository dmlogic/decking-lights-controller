<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decking lights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
</head>
<body style="background:white">
    <header class="container bg-dark bg-gradient text-white">
        <div class="d-flex align-items-center">
            <h1 class=" h3 my-2">Decking lights </h1>
            <div class="spinner-border text-secondary ms-auto" role="status" id="spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </header>
    <div class="container p-3">
        <div class="innards bg-light px-3 py-1 rounded-2">
            <div class="alert alert-danger m-3" role="alert" hidden id="error">
                <p><strong></strong></p>
                <p>Please refresh the page to try again. If this problem persists, reboot the lights.</p>
            </div>
            <div class="form-check form-switch fs-1 my-4">
                <input class="form-check-input" type="checkbox" role="switch" id="onOff" disabled>
                <label class="form-check-label fs-3" for="onOff" id="onOffLabel"></label>
            </div>
            <div id="controls" hidden>
                <div id="rgb"></div>
                <p class="m-3 text-center">
                    <button type="button" id="white" class="btn btn-light btn-md border">White</button>
                </p>
            </div>
        </div>
    </div>
<script>
const bg = document.body
const onOffSwitch = document.getElementById("onOff")
const onOffLabel = document.getElementById("onOffLabel")
const whiteSwitch = document.getElementById("white")
const controlsDisplay = document.getElementById("controls")
const busyIndicator = document.getElementById("spinner")
const preview = document.getElementById("preview")
let busy = true
let whiteValue = 0
let colorPicker

function setControlsVisibliity() {
    controlsDisplay.hidden = !onOffSwitch.checked
    onOffLabel.textContent = onOffSwitch.checked ? 'On' : 'Off'
}

function updateOnOffValue() {
    setControlsVisibliity();
    updateLights();
}

function setBusy() {
    busy = true;
    busyIndicator.hidden = false;
    onOffSwitch.disabled = true;
    whiteSwitch.disabled = true;
}

function setReady() {
    busy = false;
    busyIndicator.hidden = true;
    onOffSwitch.disabled = false;
    whiteSwitch.disabled = false;
}

function showError(msg) {
    document.querySelector('#error strong').textContent = msg;
    document.getElementById("error").hidden = false;
    setBusy();
}

function updatePreview(col) {
    bg.style.backgroundColor = colorPicker.color.hexString
}

function setWhite() {
    whiteValue = 1;
    colorPicker.color.hexString = '#ffffff'
    updatePreview();
    updateLights();
}

function updatePicker() {
    whiteValue = 0
    updateLights();
}

function updateLights() {
    if(busy) {
        return;
    }
    setBusy();
    let formData = new FormData();
    formData.append('onoff', onOffSwitch.checked ? "checked" : "off");
    formData.append('rgb', colorPicker.color.hexString );
    formData.append('white', whiteValue);

    console.log(formData.get('white'))
    fetch('/update',{
        method: "POST",
        body: formData
    })
        .then((response) => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Something went wrong');
            })
        .then((responseJson) => {
            setReady();
        })
        .catch((error) => {
            showError("Could not update lights")
        });
}

function init() {
    fetch('/status')
        .then((response) => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Something went wrong');
            })
        .then((responseJson) => {
            onOffSwitch.checked = responseJson.onoff == 'checked'
            whiteValue = responseJson.white
            bg.style.backgroundColor = responseJson.rgb

            colorPicker = new iro.ColorPicker("#rgb", {
                height: 200,
                layoutDirection: 'vertical',
                color: responseJson.rgb
            });
            colorPicker.on('color:change', updatePreview);
            colorPicker.on('input:end', updatePicker);

            setControlsVisibliity();
            setReady();
        })
        .catch((error) => {
            console.error(error)
            showError("Cannot read status from lights")
        });

}
onOffSwitch.addEventListener("change", updateOnOffValue);
whiteSwitch.addEventListener("click", setWhite);
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
