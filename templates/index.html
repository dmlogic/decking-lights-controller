<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decking lights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
</head>
<body>
    <header class="container bg-dark bg-gradient text-white">
        <div class="d-flex align-items-center">
            <h1 class="my-4">Decking lights </h1>
            <div class="spinner-border text-secondary ms-auto" role="status" hidden id="spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="form-check form-switch fs-1 my-4">
            <input class="form-check-input" type="checkbox" role="switch" id="onOff" {{ on_off }}>
            <label class="form-check-label fs-3" for="onOff" id="onOffLabel"></label>
        </div>
        <div id="controls" hidden>
            <label for="rgb" class="h2 my-4">Colour</label>
            <p>
                <input id="rgb"
                       type="color"
                       value="{{ rgb }}">
            </p>
            <label for="white" class="h2 my-4">White</label>
            <p>
                <input type="range"
                       class="form-range"
                       min="0"
                       max="100"
                       step="1"
                       id="white"
                       value="{{ white }}">
            </p>
        </div>
    </div>
<script>
const onOffSwitch = document.getElementById("onOff")
const onOffLabel = document.getElementById("onOffLabel")
const rgbSwitch = document.getElementById("rgb")
const whiteSwitch = document.getElementById("white")
const controlsDisplay = document.getElementById("controls")
const busyIndicator = document.getElementById("spinner")
let busy = false
let onOffValue = onOffSwitch.checked
let rgbValue = "{{ rgb }}"
let whiteValue = "{{ white }}"

let setControlsVisibliity = function() {
    controlsDisplay.hidden = !onOffValue
    onOffLabel.textContent = onOffValue ? 'On' : 'Off'
}

let updateOnOffValue = function() {
    onOffValue = onOffSwitch.checked
    setControlsVisibliity();
    sendValuesToServer();
}

let updateRgbValue = function() {
    rgbValue = rgbSwitch.value
    sendValuesToServer();
}

let updateWhiteValue = function() {
    whiteValue = whiteSwitch.value
    sendValuesToServer();
}

let setBusy = function() {
    busy = true;
    busyIndicator.hidden = false;
    onOffSwitch.disabled = true;
    rgbSwitch.disabled = true;
    whiteSwitch.disabled = true;
}

let setReady = function() {
    busy = false;
    busyIndicator.hidden = true;
    onOffSwitch.disabled = false;
    rgbSwitch.disabled = false;
    whiteSwitch.disabled = false;
}

let sendValuesToServer = function() {
    if(busy) {
        console.log("busy")
        return;
    }
    console.log("sending")
    setBusy();
    // setReady();
}

onOffSwitch.addEventListener("change", updateOnOffValue);
rgbSwitch.addEventListener("change", updateRgbValue);
whiteSwitch.addEventListener("change", updateWhiteValue);

setControlsVisibliity();
</script>
</body>
</html>
